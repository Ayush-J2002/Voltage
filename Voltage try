import time
import pyvisa
from multiprocessing import Process, Barrier
from datetime import datetime, timedelta
 
# 1. CONFIGURATION
#    Added 'program_number' so you can specify which program runs on which device.
PPS_DEVICES = [
    {
        "name": "Ignition", 
        "visa_resource": "USB0::0x0B3E::0x1012::EZ002640::INSTR", 
        "program_number": 1
    },
    {
        "name": "ACC", 
        "visa_resource": "USB0::0x0B3E::0x1012::EZ002641::INSTR", 
        "program_number": 1
    },
    {
        "name": "Battery Cycle", 
        "visa_resource": "USB0::0x0B3E::0x1012::EZ002642::INSTR", 
        "program_number": 2  # Example: Battery cycle might use a different program
    }
]
 
def send_command(pps, command):
    try:
        # strip() removes whitespace, adding \n ensures distinct command
        pps.write(command.strip() + "\n")
    except Exception as e:
        print(f"Error sending command '{command}': {e}")
 
def wait_for_program_completion(pps, device_name):
    """
    Polls the device status until the program finishes.
    """
    print(f"[{device_name}] Waiting for program to complete...")
    while True:
        try:
            # Check Operation Condition register (standard SCPI)
            # Returns non-zero if program is running/busy
            response = pps.query(":STAT:OPER:COND?")
            
            # If bit 0 is 0, it usually means idle/done. 
            # Adjust logic if your specific model returns different status bits.
            if "0" in response.strip(): 
                break
            
            time.sleep(1)
        except Exception as e:
            print(f"[{device_name}] Status check error: {e}")
            time.sleep(1)
 
def trigger_pps_device(device_config, barrier, start_time):
    visa_resource = device_config["visa_resource"]
    name = device_config["name"]
    prog_num = device_config["program_number"]

    try:
        rm = pyvisa.ResourceManager()
        with rm.open_resource(visa_resource) as pps:
            # Set timeout slightly higher for safety
            pps.timeout = 5000 
            print(f"[{name}] Connected.")
 
            # --- STEP 1: SELECT THE PROGRAM ---
            # We select the program BEFORE the barrier. 
            # This ensures all devices are "armed" and ready to run.
            select_cmd = f":PROG:SEL {prog_num}"
            send_command(pps, select_cmd)
            print(f"[{name}] Selected Program {prog_num}")

            # Give the device a moment to load the program from memory
            time.sleep(0.5)

            # --- STEP 2: SYNCHRONIZE ---
            # Wait here until ALL processes have connected and selected their programs
            barrier.wait()
 
            # --- STEP 3: PRECISE TIMING ---
            # Busy wait loop for high-precision start
            while datetime.now() < start_time:
                pass # spinning until exact start time
 
            # --- STEP 4: RUN ---
            send_command(pps, ":PROG:EXEC:STATe RUN")
            print(f"[{name}] Triggered RUN at {datetime.now().strftime('%H:%M:%S.%f')}")
 
            # --- STEP 5: MONITOR & CLEANUP ---
            wait_for_program_completion(pps, name)
 
            send_command(pps, "OUTP OFF")
            print(f"[{name}] Program finished. Output turned OFF.")
 
    except pyvisa.VisaIOError as e:
        print(f"[{name}] CONNECTION ERROR ({visa_resource}): {e}")
 
if __name__ == "__main__":
    # Create a barrier for the number of devices we have
    num_devices = len(PPS_DEVICES)
    barrier = Barrier(num_devices)

    # Schedule the start for 5 seconds in the future
    start_time = datetime.now() + timedelta(seconds=5)
    print(f"Starting automation... All devices will trigger at {start_time.strftime('%H:%M:%S')}")

    processes = []
    for device in PPS_DEVICES:
        # We pass the whole device dictionary now
        process = Process(target=trigger_pps_device, args=(device, barrier, start_time))
        processes.append(process)
        process.start()

    for process in processes:
        process.join()
 
    print("All PPS devices finished successfully.")
