import pyvisa
import time

# UPDATE ADDRESS
TARGET_RESOURCE = "USB0::0x0B3E::0x1012::EZ002642::INSTR"

def fix_title_and_setup():
    print("--- KIKUSUI PBZ TITLE FIX ---")
    try:
        rm = pyvisa.ResourceManager()
        pbz = rm.open_resource(TARGET_RESOURCE)
        
        # 1. Connection Setup (Mandatory for Kikusui)
        pbz.read_termination = '\n'
        pbz.write_termination = '\n'
        pbz.timeout = 5000
        
        # 2. Clear any previous errors/timeouts
        pbz.write('*CLS')
        pbz.write('ABORT')
        time.sleep(0.5)

        # 3. Select Program 1 (Using the CORRECT name "1")
        print("1. Selecting Program 1...")
        # The fix: We send "1", not "PRG01"
        pbz.write(':PROG:NAME "1"') 
        
        # Wait for it to process
        time.sleep(0.5)

        # 4. Check if selection worked
        current = pbz.query(':PROG:NAME?')
        print(f"   Current Program is now: {current.strip()}")

        # 5. Change the Title
        print("2. Changing Title to 'PYTHON_TEST'...")
        pbz.write(':PROG:TITL "PYTHON_TEST"')
        
        # Wait for save
        time.sleep(1.0)

        # 6. Verify
        new_title = pbz.query(':PROG:TITL?')
        print(f"   SUCCESS! New Title Readback: {new_title.strip()}")
        
        # 7. (Optional) Setup for ACC Pattern if Title works
        # We set the loop count to 1 so we can add steps later
        pbz.write(':PROG:LOOP 1')
        
        pbz.close()

    except Exception as e:
        print(f"Error: {e}")
        print("TIP: If Timeout, unplug USB and restart Device.")

if __name__ == "__main__":
    fix_title_and_setup()
