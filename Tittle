import pyvisa
import time

# UPDATE ADDRESS
TARGET_RESOURCE = "USB0::0x0B3E::0x1012::EZ002642::INSTR"

def fix_title_and_setup():
    print("--- KIKUSUI PBZ TITLE FIX ---")
    try:
        rm = pyvisa.ResourceManager()
        pbz = rm.open_resource(TARGET_RESOURCE)

        # Connection setup
        pbz.read_termination = '\n'
        pbz.write_termination = '\n'
        pbz.timeout = 8000  # a little larger while debugging

        # Clear and abort any previous state
        pbz.write('*CLS')
        pbz.write('ABORT')
        time.sleep(0.5)

        # Ensure output is OFF before editing program settings
        # (If your unit uses a different output command, check the manual,
        # but :OUTP OFF is the common SCPI form.)
        try:
            pbz.write(':OUTP OFF')      # turn output off before edits
            time.sleep(0.2)
        except Exception:
            # If this command fails on your model, ignore here and continue,
            # but double-check the manual for the correct output-off command.
            pass

        # 1) Select program "1" (string must be in double quotes)
        print("1. Selecting Program 1...")
        pbz.write(':PROG:NAME "1"')
        time.sleep(0.5)
        current = pbz.query(':PROG:NAME?')
        print(f"   Current Program is now: {current.strip()}")

        # 2) Use the EDIT namespace to change the title (correct SCPI)
        print('2. Changing Title using PROG:EDIT:TITL ...')
        pbz.write(':PROG:EDIT:TITL "PYTHON_TEST"')   # correct command
        time.sleep(0.8)

        # 3) Verify with the EDIT query
        new_title = pbz.query(':PROG:EDIT:TITL?')
        print(f'   SUCCESS! New Title Readback: "{new_title.strip()}"')

        # 4) Set loop using EDIT namespace as well
        pbz.write(':PROG:EDIT:LOOP 1')
        time.sleep(0.2)

        pbz.close()

    except Exception as e:
        print("Error:", e)
        print("Tips:")
        print("- Make sure the instrument's front-panel POWER and OUTPUT are in a state that allows editing (OUTPUT OFF).")
        print("- Confirm the exact SCPI commands for your PBZ model in the 'Interface/Communication' manual (PROG:EDIT:* commands).")
        print("- If you still get timeouts, increase pbz.timeout for debugging and check that the USB resource string is correct.")
        print("If Timeout: try unplugging USB and power-cycling the instrument and PC as last resort.")

if __name__ == '__main__':
    fix_title_and_setup()
