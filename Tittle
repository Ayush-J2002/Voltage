import pyvisa
import time

# UPDATE WITH YOUR ADDRESS
TARGET_RESOURCE = "USB0::0x0B3E::0x1012::EZ002642::INSTR"

def scan_pbz_status():
    print("--- KIKUSUI PBZ STATUS SCANNER ---")
    try:
        rm = pyvisa.ResourceManager()
        # Try to open with a hard reset of the interface
        pbz = rm.open_resource(TARGET_RESOURCE)
        pbz.timeout = 3000
        pbz.read_termination = '\n' 
        pbz.write_termination = '\n'

        # 1. Check Identity
        print("1. Pinging Device...")
        try:
            print(f"   Response: {pbz.query('*IDN?').strip()}")
        except:
            print("   !!! CRITICAL FAIL: Device not responding. Unplug USB and Restart Device !!!")
            return

        # 2. Force Remote Mode (To unlock front panel)
        print("2. Locking Front Panel (Remote Mode)...")
        pbz.write('SYST:REM')
        time.sleep(0.5)

        # 3. Ask: "What Program are you on right now?"
        print("3. Reading Current Program Name...")
        # This command asks the device what is currently selected
        current_prog = pbz.query(':PROG:NAME?')
        print(f"   DEVICE SAYS CURRENT PROGRAM IS: {current_prog.strip()}")

        # 4. Ask: "Do you have a title for this?"
        current_title = pbz.query(':PROG:TITL?')
        print(f"   DEVICE SAYS CURRENT TITLE IS:   {current_title.strip()}")

        print("\n--- DIAGNOSIS ---")
        clean_name = current_prog.strip().replace('"', '')
        if clean_name == "PRG01":
            print("✅ Name confirms standard 'PRG01' syntax.")
        else:
            print(f"⚠️ Name is unexpected: '{clean_name}'. We should use THIS name in our code.")

    except Exception as e:
        print(f"Error: {e}")

if __name__ == "__main__":
    scan_pbz_status()
