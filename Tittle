import pyvisa
import time

TARGET_RESOURCE = "USB0::0x0B3E::0x1012::EZ002642::INSTR"

def test_communication():
    try:
        rm = pyvisa.ResourceManager()
        # Open connection
        pbz = rm.open_resource(TARGET_RESOURCE)
        
        # 1. CONNECTION SETTINGS (Crucial for preventing Timeouts)
        pbz.read_termination = '\n'
        pbz.write_termination = '\n'
        pbz.timeout = 5000 
        
        # 2. CLEAR BUFFERS
        pbz.clear() # specific VISA command to clear the bus
        time.sleep(0.5)

        # 3. ID CHECK
        print(f"Connected to: {pbz.query('*IDN?').strip()}")

        # 4. FORCE REMOTE & RESET
        print("Forcing Remote Mode and Resetting...")
        pbz.write('SYST:REM') # Force Remote Control
        pbz.write('*RST')     # Reset parameters to default
        pbz.write('*CLS')     # Clear Error Queue
        time.sleep(2.0)       # Wait for reset to finish

        # 5. SELECT PROGRAM 1
        print("Selecting PRG01...")
        pbz.write(':PROG:NAME "PRG01"')
        time.sleep(0.5)

        # 6. ATTEMPT TO CHANGE TITLE
        print("Attempting to change title to 'PYTHON_TEST'...")
        pbz.write(':PROG:TITL "PYTHON_TEST"')
        time.sleep(1.0)

        # 7. VERIFY
        current_title = pbz.query(':PROG:TITL?').strip()
        print(f"Read back Title: {current_title}")

        if "PYTHON_TEST" in current_title:
            print("\nSUCCESS! We have control. You can now run the upload script.")
        else:
            print("\nFAILED. Title did not change. Check if device is in Local mode.")

    except Exception as e:
        print(f"\nERROR: {e}")

if __name__ == "__main__":
    test_communication()
