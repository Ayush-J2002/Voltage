import pyvisa
import time

TARGET = "USB0::0x0B3E::0x1012::EZ002642::INSTR"   # adjust if your resource differs

def set_program_loop(target=TARGET, program=1, loop_count=5):
    rm = pyvisa.ResourceManager()
    print("VISA resources detected:", rm.list_resources())

    inst = rm.open_resource(target)
    inst.read_termination = '\n'
    inst.write_termination = '\n'
    inst.timeout = 20000   # 20s timeout for safety while debugging

    try:
        print("IDN:", inst.query('*IDN?').strip())
    except Exception as e:
        print("Warning: *IDN? failed:", e)

    # Clear error queue
    try:
        inst.write('*CLS')
    except Exception:
        pass

    print(">>> Make sure the front-panel is NOT in SEQ EDIT mode (press LOCAL once, then REMOTE if needed).")
    time.sleep(0.5)

    # Select the program to edit
    print(f"Selecting program {program} ...")
    inst.write(f'PROG:NAME "{program}"')
    time.sleep(0.1)

    # Write the loop count
    print(f"Setting program loop to {loop_count} ...")
    inst.write(f'PROG:EDIT:LOOP {loop_count}')

    # Wait for completion
    try:
        opc = inst.query('*OPC?').strip()
        print("*OPC? ->", opc)
    except Exception as e:
        print("Warning: *OPC? failed:", e)

    # Read back loop value to verify
    try:
        rb = inst.query('PROG:EDIT:LOOP?').strip()
        print("PROG:EDIT:LOOP? ->", rb)
    except Exception as e:
        print("Readback failed:", e)
        # try alternate command form (some manuals vary slightly)
        try:
            rb2 = inst.query('PROG:EDIT:LOOP?').strip()
            print("Alternate readback ->", rb2)
        except Exception as e2:
            print("Alternate readback also failed:", e2)

    # Print system error queue
    try:
        print("SYST:ERR? ->", inst.query('SYST:ERR?').strip())
    except Exception as e:
        print("SYST:ERR? failed:", e)

    inst.close()

if __name__ == "__main__":
    # Example: set program 1 loop to 3 (change values as needed)
    set_program_loop(program=1, loop_count=3)
