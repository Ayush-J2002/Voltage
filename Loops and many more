# test_edit_one_step.py
# Purpose: robustly test select-then-write (unindexed) commands that you say work on your unit.
# Usage: python test_edit_one_step.py

import pyvisa, time

RESOURCE = "USB0::0x0B3E::0x1012::EZ002642::INSTR"  # change if needed
PROGRAM_SLOT = "1"   # program slot you want to edit
STEP_TO_TEST = 1
TEST_VOLT = 5.0
TEST_TIME = 0.5
TEST_CURR = 5.0      # current limit (if you want to test CURR)

def open_inst(resource, timeout_ms=5000):
    rm = pyvisa.ResourceManager()
    inst = rm.open_resource(resource)
    inst.read_termination = "\n"
    inst.write_termination = "\n"
    inst.timeout = timeout_ms
    return inst

def syserr(inst, ctx=""):
    try:
        return inst.query("SYST:ERR?").strip()
    except Exception as e:
        return f"EXC SYST:ERR? after {ctx}: {e}"

def write_and_report(inst, cmd):
    try:
        inst.write(cmd)
    except Exception as e:
        print(f"EXC writing '{cmd}': {e}")
        return
    time.sleep(0.08)
    print(f"WROTE '{cmd}' -> SYST:ERR? = {syserr(inst, cmd)}")

def query_and_report(inst, cmd):
    try:
        r = inst.query(cmd).strip()
        print(f"QUERY '{cmd}' -> '{r}'")
    except Exception as e:
        print(f"EXC querying '{cmd}': {e}")

def main():
    inst = open_inst(RESOURCE)
    try:
        print("IDN:", end=" ")
        query_and_report(inst, "*IDN?")
        # basic preparation
        for c in ("*CLS", "ABORT", "SYST:REM"):
            inst.write(c)
            time.sleep(0.02)
        # select program slot
        inst.write(f':PROG:NAME "{PROGRAM_SLOT}"')
        time.sleep(0.05)
        print("After selecting program slot:", syserr(inst, "select program"))

        # Now try select the step (this is the form you said works)
        sel_cmd = f"PROG:EDIT:STEP:SEL {STEP_TO_TEST}"
        write_and_report(inst, sel_cmd)

        # Now write VOLT (unindexed) â€” the form you observed working
        volt_cmd = f"PROG:EDIT:STEP:VOLT {TEST_VOLT}"
        write_and_report(inst, volt_cmd)

        # Write CURR (if supported)
        curr_cmd = f"PROG:EDIT:STEP:CURR {TEST_CURR}"
        write_and_report(inst, curr_cmd)

        # Write TIME (unindexed)
        time_cmd = f"PROG:EDIT:STEP:TIME {TEST_TIME}"
        write_and_report(inst, time_cmd)

        # Try a couple of readbacks (may timeout on your FW; still try)
        for q in (f"PROG:EDIT:STEP:VOLT? {STEP_TO_TEST}", f"PROG:STEP:VOLT? {STEP_TO_TEST}", "PROG:EDIT:COUN?"):
            query_and_report(inst, q)

        # Save (harmless)
        write_and_report(inst, ":PROG:SAVE")

    finally:
        try:
            inst.close()
        except:
            pass

if __name__ == "__main__":
    main()
